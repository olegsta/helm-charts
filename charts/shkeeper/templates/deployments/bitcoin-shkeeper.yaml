{{- if or .Values.btc.enabled}}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bitcoin-shkeeper
  namespace: {{ .Values.namespace }}
  labels:
    app: bitcoin-shkeeper
spec:
  replicas: 1
  selector:
    matchLabels:
      app: bitcoin-shkeeper
  template:
    metadata:
      labels:
        app: bitcoin-shkeeper
    spec:
      {{- with .Values.dev.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      containers:

      - name: app
        image: {{ .Values.bitcoin_shkeeper.image }}
        command:
        - gunicorn
        - --access-logfile=-
        - --workers=1
        - --threads=16
        - --timeout=600
        - --bind=0.0.0.0:6000
        - run:server
        ports:
        - containerPort: 6000
          name: http
        env:
          - name: BTC_USERNAME
            valueFrom:
              secretKeyRef:
                name: eth-rpc
                key: username
          - name: BTC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: btc-rpc
                key: password
          - name: SHKEEPER_BACKEND_KEY
            valueFrom:
              secretKeyRef:
                name: shkeeper-btc-key
                key: password
          - name: CURRENT_SOL_NETWORK
          {{- if .Values.bitcoin_fullnode.mainnet }}
            value: &CURRENT_BTC_NETWORK_VALUE "main"
          {{- else }}
            value: &CURRENT_BTC_NETWORK_VALUE "testnet"
          {{- end }}
          - name: FULLNODE_URL
            value: {{ .Values.bitcoin_fullnode.url }}
          {{- if .Values.bitcoin_shkeeper.external_drain_config }}
          - name: EXTERNAL_DRAIN_CONFIG
            value: {{ .Values.bitcoin_shkeeper.external_drain_config | toJson | quote }}
          {{- end }}
          {{- range $name, $value := .Values.bitcoin_shkeeper.extraEnv }}
          - name: {{ $name | quote }}
            value: {{ $value | quote }}
          {{- end }}

      - name: tasks
        image: {{ .Values.bitcoin_shkeeper.image }}
        command: ["celery", "-A", "celery_worker.celery", "worker", "--loglevel=info", "-B"]
        env:
          - name: SOL_USERNAME
            valueFrom:
              secretKeyRef:
                name: eth-rpc
                key: username
          - name: BTC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: btc-rpc
                key: password
          - name: SHKEEPER_BACKEND_KEY
            valueFrom:
              secretKeyRef:
                name: shkeeper-btc-key
                key: password
          - name: CURRENT_SOL_NETWORK
          {{- if .Values.bitcoin_fullnode.mainnet }}
            value: *CURRENT_BTC_NETWORK_VALUE
          {{- else }}
            value: *CURRENT_BTC_NETWORK_VALUE
          {{- end }}
          - name: FULLNODE_URL
            value: {{ .Values.bitcoin_fullnode.url }}
          {{- if .Values.bitcoin_shkeeper.external_drain_config }}
          - name: EXTERNAL_DRAIN_CONFIG
            value: {{ .Values.bitcoin_shkeeper.external_drain_config | toJson | quote }}
          {{- end }}
          - name: C_FORCE_ROOT
            value: "1"
          {{- range $name, $value := .Values.bitcoin_shkeeper.extraEnv }}
          - name: {{ $name | quote }}
            value: {{ $value | quote }}
          {{- end }}
      - name: redis
        image: redis
{{- end }}
